<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">

    <title>IT Chamurai</title>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1em;
        }

        .typing-effect {
            display: inline-block;
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid;
            animation: typing 2s steps(30, end), blink-caret 0.5s step-end infinite;
        }

        * {
            text-decoration: none;
        }

        a:visited {
            color: pink;
        }

        .lalala {
            background-color:   #2EC4B6;
        }

        .bg-gray-500 {
            background-color: #f1e8b8;
        }

        .laba{
            background-color: #FF6666;
        }

        .hide-cursor {
            border-right: none;
            animation: none;
        }

        .bot-message {
            max-width: 70%;
            word-wrap: break-word;
        }

        .references {
            color: rgb(255, 255, 255);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .header-container {
            padding: 20px;
            border-radius: 5px;
        }

        .font-sans {
            font-family: "Montserrat", sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            color: aliceblue;
        }

        .loader {
            text-align: center;
        }

        .loader span {
            display: inline-block;
            vertical-align: middle;
            width: 15px;
            height: 15px;
            background: black;
            border-radius: 15px;
            animation: loader 0.8s infinite alternate;
        }

        .loader span:nth-of-type(2) {
            animation-delay: 0.2s;
        }

        .loader span:nth-of-type(3) {
            animation-delay: 0.6s;
        }

        @keyframes loader {
            0% {
                opacity: 0.9;
                transform: scale(0.5);
            }

            100% {
                opacity: 0.1;
                transform: scale(1);
            }
        }

        .hide_ele {
            display: none;
        }
    </style>
</head>

<body class="lalala font-sans">
    <div class="backdrop-blur-sm bg-white/30 h-5 w-5">
        <!-- ... -->
      </div>
      
    <div class="container mx-auto px-4 py-8 h-screen">
        <div class="bg-white shadow-lg rounded-lg p-6 h-full flex flex-col bg-gray-500">
            <div class="mb-4 flex rounded-lg shadow-lg justify-between items-center laba">
                <div class="header-container flex text-center">
                    <h2 class="text-2xl font-semibold text-lalala font-sans ">University of Northampton</h2>
                </div>
                <button id="voice-button"
                    class="lalala hover:lalala text-white px-4 py-2 rounded-lg focus:outline-none m-2">
                    <img class="max-h-5"
                        src="https://banner2.cleanpng.com/20190802/pik/kisspng-icon-design-editorial-team-coming-soon-conscious-business-5d445709a91387.2490968115647598176925.jpg"
                        alt="">
                </button>
            </div>
            <div id="chat-messages" class="container flex-grow overflow-y-auto"></div>
            <div class="mt-4">
                <input id="user-input" type="text"
                    class="w-full px-4 py-2 border border-lalala rounded-lg focus:outline-none focus:ring-2 focus:ring-lalala text-black"
                    placeholder="Type your message..." required>
            </div>
        </div>
    </div>
    <script>

        let QUESTION_ASKED = ''        

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://localhost:1234/v1", true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                // Process the response here
                console.log(response);
            }
        };
        xhr.send();





        document.addEventListener('DOMContentLoaded', function () {
            // Display the initial greeting message and options when the page loads
            displayInitialGreeting();
        });


        //This functions adds the typing thing to the message box
        function typingBuffer() {
            displayHTML("", "<span class='loader'><span></span><span></span><span></span></span>", "bot")
        }

        //This function removes the typing thing from the message box
        function removeTypingBuffer() {
            var eles = document.getElementsByClassName('loader');
            for (var i = 0; i < eles.length; i++) {
                var ele = eles[i].parentElement.parentElement;
                ele.classList.add('hide_ele');
            }
        }

        function remove_parent(class_name){
            var eles = document.getElementsByClassName(class_name)
            for(var i=0;i<eles.length;i++){
                ele = eles[i];
                ele.parentElement.parentElement.classList.add('hide_ele');
            }
        }


        function displayInitialGreeting() {
            displayMessage('Hello there, please select from the drop-down menu the topic of conversation you may need some assistance in and ask away. This makes my job just a little bit easier :)', 'bot');
            displayHTML("Please select from options below", `<div class="flex-1 font-sans"> 
    <button class="bg-red-500 pl-2 pr-2 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" onclick="preCursor('University Accommodation','accomodation')"> University Accommodation</button>
    <button class="bg-green-500 pl-2 pr-2 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" onclick="preCursor('About AI & Data Science','AI Course')">  About AI & Data Science</button>
    <button class="bg-yellow-500 pl-2 pr-2 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded" onclick="preCursor('Internships & Placements','internships')">  Internships & Placements</button>
    <button class="bg-pink-500 pl-2 pr-2 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded" onclick="preCursor('Student Life','student life')">  Student Life</button></div>
`, 'bot')

        }



        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const voiceButton = document.getElementById('voice-button');

        userInput.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                const userMessage = userInput.value;
                displayMessage(userMessage, 'user');
                sendMessage(userMessage);
                userInput.value = '';
            }
        });

        voiceButton.addEventListener('click', function () {
            const lastBotMessage = chatMessages.lastElementChild.querySelector('p').textContent;
            speakMessage(lastBotMessage);
        });

        function displayMessage(message, sender, references) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', 'mb-4', "backdrop-blur-xl");

            if (sender === 'bot') {

                removeTypingBuffer();

                messageElement.innerHTML = `
                    
                <img src="logo.png" class="h-14 w-14 mr-2 rounded-full">
                    <div class="lalala text-justify text-black p-3 rounded-lg bot-message text-wrap overflow-auto max-w-96 shadow-lg  bg-white/30">
                        <p class="typing-effect font-sans"></p>
                    </div>
                    
                `;
                const typingElement = messageElement.querySelector('.typing-effect');
                typeMessage(message, typingElement, references);
            } else {
                messageElement.classList.add('justify-end');
                messageElement.innerHTML = `
                    <div class="lalala text-black p-3 rounded-lg max-w-xs shadow-lg ">
                        <p class="font-sans">${message}</p>
                    </div>
                    <img src="user.png" alt="Bot Logo" class="h-10 w-10 ml-2 rounded-full">
                `;
            }

            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function preCursor(message, trigger) {
            displayMessage(message, 'not_bot');
            sendMessage(trigger);
        }


        function typeMessage(message, element, references) {
            console.log(references)
            let i = 0;
            element.classList.add('hide-cursor');
            const typing = setInterval(() => {
                if (i < message.length) {
                    if ((i % 100) === 99) {
                        let j = i;
                        for (j = i; j < message.length; j++) {
                            element.innerHTML += message.charAt(j);
                            if (message[j] === ' ') {
                                break;
                            }
                        }
                        i = j + 1;
                        element.innerHTML += '<br>';
                    } else {
                        element.innerHTML += message.charAt(i);
                        i++;
                    }
                } else {
                    clearInterval(typing);
                    if (references) {
                        console.log("haha");
                        element.insertAdjacentHTML('afterend', `<div class="references">${references}</div>`);
                    }
                }
            }, 5);
            element.classList.add('text-justify');
        }
        function speakMessage(message) {
            const speech = new SpeechSynthesisUtterance(message);
            window.speechSynthesis.speak(speech);
        }

        function feedback_loop(message){
            displayMessage(message,'bot');
            remove_parent(class_name = 'feedback_que');
        }
        async function sendMessage(message) {
            try {
                typingBuffer()
                QUESTION_ASKED = message;
                const response = await fetch('http://localhost:5005/webhooks/rest/webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sender: 'user', message: message })
                });

                const data = await response.json();

                if (data && data.length > 0 && data[0].text) {
                    const botMessage = data[0].text;
                    const references = extractReferences(botMessage);
                    console.log(references);
                    const messageWithoutReferences = removeReferences(botMessage);
                    //openai(messageWithoutReferences,QUESTION_ASKED)
                    const res = await openai(messageWithoutReferences,QUESTION_ASKED);
                    displayMessage(res, 'bot', references);

                    displayHTML("",
                        `   <span class="flex-1 font-sans feedback_que"> 
                                        Did that answer your question?
                                        <button class="bg-green-500 pl-2 pr-2 hover:bg-green-700 text-white font-bold py-2 rounded-lg" onclick="feedback_loop('Thank you for the feedback! Is there anything else that I can help you with?','bot')">Yes</button>
                                        <button class="bg-red-500 pl-2 pr-2 hover:bg-red-700 text-white font-bold py-2 rounded-lg" onclick="feedback_loop('I am really sorry, I will report this incident to the team! Thanks for bearing with us!','bot')" >No </button>
                                    </span>
                                `, 'bot')
                } else {
                    console.error('Unexpected response format:', data);
                    displayMessage('Sorry, I encountered an error.', 'bot');
                }
            } catch (error) {
                console.error('Error:', error);
                displayMessage('Sorry, I encountered an error.', 'bot');
            }

        }

        function extractReferences(message) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const references = message.match(urlRegex);
            if (references) {
                return references.map((url, index) => `<span style="color: purple;">[${index + 1}]</span> <a href="${url}" target="_blank" style="color: purple;">${url}</a>`).join('<br>');
            }
            return null;
        }

        function removeReferences(message) {
            return message.replace(/\(https?:\/\/[^\s]+\)/g, "[1]").trim();
        }



        function displayHTML(message, htm_passed, sender, references) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', 'mb-4');

            if (sender === 'bot') {

                messageElement.innerHTML = `
                    
                <img src="logo.png" class="h-14 w-14 mr-2 rounded-full">
                    <div class="lalala text-justify text-black p-3 rounded-lg bot-message text-wrap overflow-auto max-w-96 shadow-lg ">
                        <p class="typing-effect font-sans"></p>
                        ${htm_passed}
                    </div>
                
                `;
                const typingElement = messageElement.querySelector('.typing-effect');
                typeMessage(message, typingElement, references);
            } else {
                messageElement.classList.add('justify-end');
                messageElement.innerHTML = `
                    <div class="lalala text-black p-3 rounded-lg max-w-xs shadow-lg font-sans ">
                        <p>${message}</p>
                    </div>
                    <img src="user.png" alt="Bot Logo" class="h-10 w-10 ml-2 rounded-full font-sans">
                `;
            }

            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }


        //const fetch = require('node-fetch');

        async function openai(message,question) {
            const response = await fetch('http://localhost:1234/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer lm-studio' // Replace YOUR_API_KEY_HERE with your actual API key
                },
                body: JSON.stringify({
                    model: "lmstudio-community/Meta-Llama-3-8B-Instruct-GGUF",
                    messages: [
                        {
                            role: "system",
                            content: "You are a uni of Northampton BOT, You are to hooked into backend of RASA, to better serve the purposes of the chatbot, do not modify the answer in an inappropriate way. Please start with Sure! If the question do not makes sense make sure to say it again! Please!! "
                        },
                        {
                            role: "user",
                            content: "Please be professional! Do not mention anything about RASA, jsut tailor the info to the question thanks! question is" + question + "\n" + "answer emitted by RASA is" + message
                        }
                    ],
                    temperature: 0.1
                })
            });

            const data = await response.json();
            console.log(data.choices[0].message.content);   
            return data.choices[0].message.content;
        }

    </script>
</body>

</html>

<!--/\(https?:\/\/[^\s]+\)/g, '[1]'-->